<!DOCTYPE html>
<!-- Copyright 2018 Pascal COMBES <pascom@orange.fr>

     This file is part of SolarProd.

     SolarProd is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
     the Free Software Foundation, either version 3 of the License, or
     (at your option) any later version.

     SolarProd is distributed in the hope that it will be useful,
     but WITHOUT ANY WARRANTY; without even the implied warranty of
     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
     GNU General Public License for more details.

     You should have received a copy of the GNU General Public License
     along with SolarProd. If not, see <http://www.gnu.org/licenses/>
-->

<html>
    <head>
        <meta charset='utf-8' />
        <title>Ducomquet: Production solaire</title>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <script src="js/d3.js" charset="utf-8"></script>
        <script src="js/FileSaver.js" charset="utf-8"></script>
        <script src="js/locale.js" charset="utf-8"></script>
        <script src="js/solardata.js" charset="utf-8"></script>
        <script src="js/linedata.js" charset="utf-8"></script>
        <script src="js/histdata.js" charset="utf-8"></script>
        <script src="js/solarplot.js" charset="utf-8"></script>
        <script src="js/lineplot.js" charset="utf-8"></script>
        <script src="js/histplot.js" charset="utf-8"></script>
        <script src="js/solarchart.js" charset="utf-8"></script>
    </head>
    <body>
        <div>
            <div class="toolbar">
                <select id="day" title="Jour">
                </select>
                <select id="month" title="Mois">
                </select>
                <select id="year" title="Année">
                </select>
                <select id="var" title="Variable">
                </select>
                <select id="sum" title="Aggrégation">
                </select>
                <img id="plot" class="button" src="img/plot.png" alt="Tracer" title="Tracer" />
            </div>
            <div class="toolbar">
                <img id="prev" class="button disabled" src="img/prev.png" alt="Précédent" title="Précédent" />
                <img id="today" class="button" src="img/today.png" alt="Aujourd'hui" title="Aujourd'hui" />
                <img id="next" class="button disabled" src="img/next.png" alt="Suivant" title="Suivant" />
                <img id="export" class="button disabled" src="img/csv.png" alt="Export CSV" title="Export CSV" />
            </div>
        </div>
        <script>
// Disables selects:
d3.select('#day').attr('disabled', true);
d3.select('#month').attr('disabled', true);
d3.select('#year').attr('disabled', true);
d3.select('#var').attr('disabled', true);
d3.select('#sum').attr('disabled', true);

// Day and month to select:
var selectMonth = 0;
var selectDay = 0;
var selectDir = 1;
// Cache for first/last day, month and year:
var cache = {};

var data = SolarData.create([], '', '', '');
var chart = new SolarChart(d3.select('body'),/*d3.select('#chart'), */data);
var legend = chart.legendRoot;

// Window resize event:
function windowResize()
{   
    // Compute toolbar total width (currently 403):
    //var tw = 20;
    //d3.selectAll('.toolbar').each(function() {tw += this.clientWidth;});

    // Plot width and height:
    var w = window.innerWidth - 18;
    var h = window.innerHeight - 56;
    if (window.innerWidth < 403)
        h -= 38;

    chart.resize(w, h);
}

// Update visibility in legend so that it matches the visility of the element:
function updateVisibility()
{
    // Ensure the checkboxes match the visility of the elements:
    legend.selectAll('input').each(function(d) {
        if (d[0] === undefined) {
            this.checked = (d3.select(d).style('display') != 'none');
        } else {
            var allSelected = true;
            var anySelected = false;
            d.forEach(function(e) {
                allSelected &= (d3.select(e).style('display') != 'none');
                anySelected |= (d3.select(e).style('display') != 'none');
            });
            this.checked = anySelected;
            this.indeterminate = !allSelected && anySelected;
        }
    });
}

// Change the visibility of an element:
function changeVisiblilty(d)
{
    var selection;
    if (chart.plot.groups !== undefined) {
        var group;
        var elem;
        
        // Get group number for current element:
        chart.plot.groups.filter(function(d, i) {return i == 0;})
                         .selectAll('g').each(function(e, i) {
            d3.select(this).selectAll('rect').each(function(e, j) {
                var element = this;
                if ((d[0] === undefined) && (d == element))
                    group = i;
                if (d[0] !== undefined)
                    d.forEach(function(e) {if (e == element) group = i;});
            });
        });
        // Get element number for current element (if it is an element):
        chart.plot.groups.filter(function(d, i) {return i == 0;})
                         .selectAll('g').selectAll('rect').each(function(e, i) {
            if (this == d)
                elem = i;
        });
        console.log('group:', group, 'elem:', elem);
        
        // Get all element at position elem in group group:
        selection = chart.plot.groups.selectAll('g').filter(function(e, i) {return (i == group);});
        selection = selection.selectAll('rect').filter(function(e, i) {return (elem === undefined ? true : (i == elem));});
    } else {
        selection = (d[0] === undefined) ? d3.select(d) : d3.selectAll(d);
    }
    
    // Show/hides elements:
    if (d3.select(d3.event.target).property('checked'))
        selection.style('display', 'initial');
    else
        selection.style('display', 'none');
        
    updateVisibility();
}

// Draw the legend:
function drawLegend(paths)
{
    var sum = data.aggregation();
    if (sum == null)
        sum = 'sum';
        
    if (!legend)
        return;
    legend.selectAll('*').remove();
    legend.append('h4').text('Légende');
    
    // Functions for styling legend items:
    var style = chart.plot.legendStyle;
    if (style === null)
        return;
        
    // Creates legend (using lists)
    if (sum == 'sum') {
        legend.append('span').html('&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;').call(style);
        legend.append('span').text(' Total');
    } else {
        var inv = legend.append('ul').selectAll('li')
                                     .data(paths._groups);
        inv = inv.enter().append('li');
        inv.append('span').classed('label', true);
        
        if (sum == 'str') {
            inv.select('span').append('span').text(function(d, i) {return 'Onduleur ' + (i + 1);});
            inv.append('span').classed('input', true)
                              .append('input')
                              .attr('type', 'checkbox')
                              .on('change', changeVisiblilty);
            
            var str = inv.append('ul').selectAll('li')
                                      .data(function(d) {return d;});
            str = str.enter().append('li');
            str.append('span').classed('label', true);
            
            str.select('span').append('span').html('&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;').call(style);
            str.select('span').append('span').text(function(d, i) {return ' String ' + (i + 1);});
            str.append('span').classed('input', true)
                              .append('input')
                              .attr('type', 'checkbox')
                              .on('change', changeVisiblilty);
        } else {
            inv.select('span').append('span').html('&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;').call(style);
            inv.select('span').append('span').text(function(d, i) {return ' Onduleur ' + (i + 1);});
            inv.append('span').classed('input', true)
                              .append('input')
                              .attr('type', 'checkbox')
                              .on('change', changeVisiblilty);
        }
        
        updateVisibility();
    }
}

// Fetch data:
function plot(today) {
    // The selected date:
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    // Constructs data path:
    var file = '';
    var folder = '';
    if (day != '') {
        while (day.length < 2)
            day = "0" + day;
        folder = (folder == '') ? 'days' : folder;
        file = "/" + day + file;
    }
    if (month != '') {
        while (month.length < 2)
            month = "0" + month;
        folder = (folder == '') ? 'months' : folder;
        file = "/" + month + file;
    }
    if (year != '') {
        folder = (folder == '') ? 'years' : folder;
        file = "/" + year + file;
    }
    if (file == '')
        file = 'years';
    if (today) {
        file = 'today';
        folder = '';
        selectMonth = -1;
        selectDay = -1;
        selectDir = 1;
        d3.select('#year').property('value', d3.select('#year').selectAll('option')
                                                               .filter(function() {return (this.nextElementSibling == null);})
                                                               .attr('value'));
        updateMonths();
        updatePrevNext();
    }
    console.log("Data file path: " + folder + file + '.json')
    
    // Fetch the data with AJAX:
    d3.json('data/' + folder + file + '.json').on('error', function(error) {
        console.warn('Error:', error);
    }).on('load', function(json) {
        // Transform json into solar data:
        if (today)
            data = SolarData.create(json);
        else
            data = SolarData.create(json, year, month, day);
        updateVariables();
        chart.setData(data);
        
        // Activate export:
        d3.select('#export').classed('disabled', false);
    }).get();
}

// Updates the variable selector:
function updateVariables()
{
    // Adds the new variables using a data join:
    var vars = d3.select('#var')
                 .attr('disabled', null)
                 .selectAll('option')
                 .data(data.validVars, (d) => d);
    vars.enter()
        .append('option')
        .attr('value', (d) => d)
        .text(SolarData.variableName);
    vars.exit().remove();
    vars.order();
    
    // Updates sums if needed:
    if (d3.select('#var').property('value') != data.variable()) {
        data.variable(d3.select('#var').property('value'));
        updateSums();
    }
}

// Updates the sum selector:
function updateSums()
{
    // Adds the new sums using a data join:
    var sums = d3.select('#sum')
                 .attr('disabled', (data.validAggs.length < 2) ? true : null)
                 .selectAll('option')
                 .data(data.validAggs, (d) => d);
    sums.enter()
        .append('option')
        .attr('value', (d) => d)
        .text(SolarData.aggregationName);
    sums.exit().remove();
    sums.order();
}

// Get cache:
d3.json("list/cache.json", function(json) {
    if (json) {
        cache = json;
    }
});

// Update cache:
function updateCache()
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    if (selectDay == 1)
        cache.lastDay = [year, month, day];
    else if (selectDay == -1)
        cache.firstDay = [year, month, day];
    else if (selectMonth == 1)
        cache.lastMonth = [year, month];
    else if (selectMonth == -1)
        cache.firstMonth = [year, month];
    else
        return;
    
    selectDir = 1;
    console.log('Updated cache:', cache);
    updatePrevNext();
}

// Update years selector:
d3.json("list/years.json", function(json) {
    if (json) {
        json.unshift('');
        d3.select('#year').attr('disabled', null)
                        .selectAll('option')
                        .data(json)
                        .enter()
                        .append('option')
                        .attr('value', function(d) {return d;})
                        .text(function(d) {return d;});
    }
});

// Update months selector:
function updateMonths(callPlot)
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    
    d3.select('#month').attr('disabled', true);
    d3.select('#day').attr('disabled', true);
    
    if (year == '') {
        d3.select('#month')
          .attr('disabled', true)
          .selectAll('option').remove();
        d3.select('#day')
          .attr('disabled', true)
          .selectAll('option').remove();
        if (callPlot)
            plot();
        return;
    }
    console.log("Selected new year: " + year);
    
    // Fetch available months with AJAX:
    d3.json("list/months/" + year + ".json", function(json) {
        if (json === null) {
            d3.select('#month')
              .attr('disabled', true)
              .selectAll('option').remove();
            d3.select('#day')
              .attr('disabled', true)
              .selectAll('option').remove();
            if (selectMonth*selectDir < 0)
                prevYearPlot(callPlot);
            else if (selectMonth*selectDir > 0)
                nextYearPlot(callPlot);
            if (callPlot)
                plot();
            return;
        }
        json.unshift('');
        
        var months = d3.select('#month')
                       .attr('disabled', null)
                       .selectAll('option')
                       .data(json, function(d) {return d;});
        months.enter()
              .append('option')
              .attr('value', function(d) {return d;})
              .text(function(d) {return (d == '') ? '' : localeLongMonth(new Date(year, d - 1));});
        months.exit().remove();
        
        d3.select('#month')
          .selectAll('option')
          .filter(function(d) {return (d == '');})
          .lower();
        
        if (selectMonth*selectDir > 0)
            d3.select('#month').property('value', json[selectMonth*selectDir]);
        if (selectMonth*selectDir < 0)
            d3.select('#month').property('value', json[json.length + selectMonth*selectDir]);
        if (selectMonth != 0)
            updatePrevNext();
        if ((selectDay == 0) && (selectDir == -1))
            updateCache();
        selectMonth = 0;
        
        updateDays(callPlot);
        if ((callPlot) && (d3.select('#day').property('value') == ''))
            plot();
    });
}

// Update days selector:
function updateDays(callPlot)
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    
    if (month == '') {
        d3.select('#day')
          .attr('disabled', true)
          .selectAll('option').remove();
        if (callPlot)
            plot();
        return;
    }
    
    while (month.length < 2)
        month = "0" + month;
    console.log("Selected new month: " + month + "/" + year);
    
    // Fetch available days with AJAX:
    d3.json("list/days/" + year + "/" + month + ".json", function(json) {
        if (json === null) {
             d3.select('#day')
               .attr('disabled', true)
               .selectAll('option').remove();
            if (selectDay*selectDir < 0)
                prevMonthPlot(callPlot);
            else if (selectDay*selectDir > 0)
                nextMonthPlot(callPlot);
            if (callPlot)
                plot();
            return;
        }
        json.unshift('');
        
        var days = d3.select('#day')
                     .attr('disabled', null)
                     .selectAll('option')
                     .data(json, function(d) {return d;});
        days.enter()
            .append('option')
            .attr('value', function(d) {return d;})
            .text(function(d) {return d;});
        days.exit().remove();
        
        d3.select('#days')
          .selectAll('option')
          .filter(function(d) {return (d == '');})
          .lower();
          
        if (selectDay*selectDir > 0)
            d3.select('#day').property('value', json[selectDay*selectDir]);
        if (selectDay*selectDir < 0)
            d3.select('#day').property('value', json[json.length + selectDay*selectDir]);
        if (selectDay != 0)
            updatePrevNext();
        if (selectDir == -1)
            updateCache();
        selectDay = 0;
        
        if (callPlot)
            plot();
    });
}

// Get previous option(s):
function prevOption(d3Select, datum)
{
    if (datum == '')
        return null;
    
    var p = d3Select.selectAll('option')
                    .filter(function(d) {return d == datum;})
                    .selectAll(function() {return [this.previousElementSibling];});
    
    if (p.empty() ||  (p.attr('value') == ''))
        return null;
    return p;
}

// Get next option(s):
function nextOption(d3Select, datum)
{
    if (datum == '')
        return null;
   
    var n = d3Select.selectAll('option')
                    .filter(function(d) {return d == datum;})
                    .selectAll(function() {return [this.nextElementSibling];});
                    
    if (n.empty())
        return null;
    return n;
}

// Update the states of previous and next buttons:
function updatePrevNext()
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    var isFirst = false;
    var isLast = false;
    if ((year != '') && (month != '') && (day != '')) {
        isFirst = (cache.firstDay !== undefined) && (year == cache.firstDay[0]) && (month == cache.firstDay[1]) && (day == cache.firstDay[2]);
        isLast = (cache.lastDay !== undefined) && (year == cache.lastDay[0]) && (month == cache.lastDay[1]) && (day == cache.lastDay[2]);
    } else if ((year != '') && (month != '')) {
        isFirst = (cache.firstMonth !== undefined) && (year == cache.firstMonth[0]) && (month == cache.firstMonth[1]);
        isLast = (cache.lastMonth !== undefined) && (year == cache.lastMonth[0]) && (month == cache.lastMonth[1]);
    } else if (year != '') {
        isFirst = (cache.firstYear !== undefined) && (year == cache.firstYear[0]);
        isLast = (cache.lastYear !== undefined) && (year == cache.lastYear[0]);
    }
    
    var prevDay = (year != '') && (month != '') ? prevOption(d3.select('#day'), day) : null;
    var nextDay = (year != '') && (month != '') ? nextOption(d3.select('#day'), day) : null;
    
    var prevMonth = (year != '') ? prevOption(d3.select('#month'), month) : null;
    var nextMonth = (year != '') ? nextOption(d3.select('#month'), month) : null;

    var prevYear = prevOption(d3.select('#year'), year);
    var nextYear = nextOption(d3.select('#year'), year);

    d3.select('#prev').classed('disabled', isFirst || (!prevDay && !prevMonth && !prevYear));
    d3.select('#next').classed('disabled', isLast || (!nextDay && !nextMonth && !nextYear));
}

// Plots data for previous day:
function prevDayPlot(callPlot)
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    if ((cache.firstDay !== undefined) && (year == cache.firstDay[0]) && (month == cache.firstDay[1]) && (day == cache.firstDay[2]))
        return;
    
    var prevDay = prevOption(d3.select('#day'), day);
    if (prevDay) {
        d3.select('#day').property('value', prevDay.attr('value'));
        updatePrevNext();
        if (callPlot)
            plot();
    } else {
        selectDay = -selectDir;
        prevMonthPlot(callPlot);
    }
}

// Plots data for previous month:
function prevMonthPlot(callPlot)
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    
    if ((cache.firstMonth !== undefined) && (year == cache.firstMonth[0]) && (month == cache.firstMonth[1])) {
        if (selectDay != 0) {
            selectDir = -1;
            nextDayPlot(callPlot);
        }
        return;
    }
    
    var prevMonth = prevOption(d3.select('#month'), month);
    if (prevMonth) {
        d3.select('#month').property('value', prevMonth.attr('value'));
        updatePrevNext();
        updateDays(callPlot);
    } else {
        selectMonth = -selectDir;
        prevYearPlot(callPlot);
    }
}

// Plots data for previous year:
function prevYearPlot(callPlot)
{
    var year = d3.select('#year').property('value');
    
    if ((cache.firstYear !== undefined) && (year == cache.firstYear[0])) {
        if (selectDay != 0) {
            selectDir = -1;
            nextDayPlot(callPlot);
        } else if (selectMonth != 0) {
            selectDir = -1;
            nextMonthPlot(callPlot);
        }
        return;
    }
    
    var prevYear = prevOption(d3.select('#year'), year);
    if (prevYear) {
        d3.select('#year').property('value', prevYear.attr('value'));
        updatePrevNext();
        updateMonths(callPlot);
    } else {
        d3.select('#prev').classed('disabled', true);
        selectDir = -1;
        if (selectDay != 0)
            nextDayPlot(callPlot);
        else if (selectMonth != 0)
            nextMonthPlot(callPlot);
    }
}

// Plots data for previous year/month/day:
function prevPlot()
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    if (day != '')
        prevDayPlot(true);
    else if (month != '')
        prevMonthPlot(true);
    else if (year != '')
        prevYearPlot(true);
}

// Plots data for next day:
function nextDayPlot(callPlot)
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    if ((cache.lastDay !== undefined) && (year == cache.lastDay[0]) && (month == cache.lastDay[1]) && (day == cache.lastDay[2]))
        return;
    
    var nextDay = nextOption(d3.select('#day'), day);
    if (nextDay) {
        d3.select('#day').property('value', nextDay.attr('value'));
        updatePrevNext();
        if (callPlot)
            plot();
    } else {
        selectDay = selectDir;
        nextMonthPlot(callPlot);
    }
}

// Plots data for next month:
function nextMonthPlot(callPlot)
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    
    if ((cache.lastMonth !== undefined) && (year == cache.lastMonth[0]) && (month == cache.lastMonth[1])) {
        if (selectDay != 0) {
            selectDir = -1;
            prevDayPlot(callPlot);
        }
        return;
    }
    
    var nextMonth = nextOption(d3.select('#month'), month);
    if (nextMonth) {
        d3.select('#month').property('value', nextMonth.attr('value'));
        updatePrevNext();
        updateDays(callPlot);
    } else {
        selectMonth = selectDir;
        nextYearPlot(callPlot);
    }
}

// Plots data for next year:
function nextYearPlot(callPlot)
{
    var year = d3.select('#year').property('value');
    var nextYear = nextOption(d3.select('#year'), year);
    
    if ((cache.lastYear !== undefined) && (year == cache.lastYear[0])) {
        if (selectDay != 0) {
            selectDir = -1;
            prevDayPlot(callPlot);
        } else if (selectMonth != 0) {
            selectDir = -1;
            prevMonthPlot(callPlot);
        }
        return;
    }
    
    if (nextYear) {
        d3.select('#year').property('value', nextYear.attr('value'));
        updatePrevNext();
        updateMonths(callPlot);
    } else {
        d3.select('#next').classed('disabled', true);
        selectDir = -1;
        if (selectDay != 0)
            prevDayPlot(callPlot);
        else if (selectMonth != 0)
            prevMonthPlot(callPlot);
    }
}

// Plots data for next year/month/day:
function nextPlot()
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    if (day != '')
        nextDayPlot(true);
    else if (month != '')
        nextMonthPlot(true);
    else if (year != '')
        nextYearPlot(true);
}

function exportCsv()
{
    var exportData = data.export();
    if (!exportData)
        return;

    // Create CSV from data:
    var csv = new Blob([[
        exportData.headers.map((line) => line.join(',')).join('\r\n'),
        exportData.data.map((line) => line.join(',')).join('\r\n')
    ].join('\r\n')], {type: 'text/csv;charset=utf-8'});
    saveAs(csv, data.exportFilename());
}


// Events connections:
d3.select('#var').on('change', function() {
    data.variable(d3.select(this).property('value'));
    updateSums();
    chart.draw();
});
d3.select('#sum').on('change', function() {
    data.aggregation(d3.select(this).property('value'));
    chart.draw();
});

d3.select('#year').on('change', function() {
    updatePrevNext();
    updateMonths();
});
d3.select('#month').on('change', function() {
    updatePrevNext();
    updateDays();
});
d3.select('#day').on('change', updatePrevNext);

d3.select('#plot').on('click', plot);
d3.select('#prev').on('click', prevPlot);
d3.select('#today').on('click', function() {plot(true);});
d3.select('#next').on('click', nextPlot);
d3.select('#export').on('click', exportCsv);

d3.select(window).on('resize', windowResize);
windowResize();
        </script>
    </body>
</html>
 
