<!DOCTYPE html>
<!-- Copyright 2018 Pascal COMBES <pascom@orange.fr>

     This file is part of SolarProd.

     SolarProd is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
     the Free Software Foundation, either version 3 of the License, or
     (at your option) any later version.

     SolarProd is distributed in the hope that it will be useful,
     but WITHOUT ANY WARRANTY; without even the implied warranty of
     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
     GNU General Public License for more details.

     You should have received a copy of the GNU General Public License
     along with SolarProd. If not, see <http://www.gnu.org/licenses/>
-->

<html>
    <head>
        <meta charset='utf-8' />
        <title>Ducomquet: Production solaire</title>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <script src="js/d3.js" charset="utf-8"></script>
        <script src="js/FileSaver.js" charset="utf-8"></script>
        <script src="js/locale.js" charset="utf-8"></script>
        <script src="js/solardata.js" charset="utf-8"></script>
        <script src="js/linedata.js" charset="utf-8"></script>
        <script src="js/histdata.js" charset="utf-8"></script>
        <script src="js/solarplot.js" charset="utf-8"></script>
        <script src="js/lineplot.js" charset="utf-8"></script>
        <script src="js/histplot.js" charset="utf-8"></script>
        <script src="js/solarlegend.js" charset="utf-8"></script>
        <script src="js/solarchart.js" charset="utf-8"></script>
        <script src="js/solarprod.js" charset="utf-8"></script>
    </head>
    <body>
        <script>
// Cache for first/last day, month and year:
var cache = {};

var app = new SolarProd();

// Updates the variable selector:
function updateVariables(data)
{
    // Adds the new variables using a data join:
    var vars = d3.select('#var')
                 .attr('disabled', null)
                 .selectAll('option')
                 .data(data.validVars, (d) => d);
    vars.enter()
        .append('option')
        .attr('value', (d) => d)
        .text(SolarData.variableName);
    vars.exit().remove();
    vars.order();
    
    // Updates sums if needed:
    if (d3.select('#var').property('value') != data.variable()) {
        data.variable(d3.select('#var').property('value'));
        updateSums(data);
    }
}

// Event handler:
d3.select('#var').on('change', function() {
    app.chart.plot.data.variable(d3.select(this).property('value'));
    updateSums(app.chart.plot.data);
    app.chart.draw();
});

// Updates the sum selector:
function updateSums(data)
{
    // Adds the new sums using a data join:
    var sums = d3.select('#sum')
                 .attr('disabled', (data.validAggs.length < 2) ? true : null)
                 .selectAll('option')
                 .data(data.validAggs, (d) => d);
    sums.enter()
        .append('option')
        .attr('value', (d) => d)
        .text(SolarData.aggregationName);
    sums.exit().remove();
    sums.order();
}

// Event handler:
d3.select('#sum').on('change', function() {
    app.chart.plot.data.aggregation(d3.select(this).property('value'));
    app.chart.draw();
});

// Get previous option(s):
function prevOption(d3Select, datum)
{
    if (datum == '')
        return null;
    
    var p = d3Select.selectAll('option')
                    .filter(function(d) {return d == datum;})
                    .selectAll(function() {return [this.previousElementSibling];});
    
    if (p.empty() ||  (p.attr('value') == ''))
        return null;
    return p;
}

// Get next option(s):
function nextOption(d3Select, datum)
{
    if (datum == '')
        return null;
   
    var n = d3Select.selectAll('option')
                    .filter(function(d) {return d == datum;})
                    .selectAll(function() {return [this.nextElementSibling];});
                    
    if (n.empty())
        return null;
    return n;
}

// Update the states of previous and next buttons:
function updatePrevNext()
{
    var year = d3.select('#year').property('value');
    var month = d3.select('#month').property('value');
    var day = d3.select('#day').property('value');
    
    var prevDay = (year != '') && (month != '') ? prevOption(d3.select('#day'), day) : null;
    var nextDay = (year != '') && (month != '') ? nextOption(d3.select('#day'), day) : null;
    
    var prevMonth = (year != '') ? prevOption(d3.select('#month'), month) : null;
    var nextMonth = (year != '') ? nextOption(d3.select('#month'), month) : null;

    var prevYear = prevOption(d3.select('#year'), year);
    var nextYear = nextOption(d3.select('#year'), year);

    d3.select('#prev').classed('disabled', app.cache.isFirst(year, month, day) || (!prevDay && !prevMonth && !prevYear));
    d3.select('#next').classed('disabled', app.cache.isLast(year, month, day) || (!nextDay && !nextMonth && !nextYear));
}

// Window resize event:
function windowResize()
{
    // Compute toolbar total width (currently 403):
    //var tw = 20;
    //d3.selectAll('.toolbar').each(function() {tw += this.clientWidth;});

    // Plot width and height:
    var w = window.innerWidth - 18;
    var h = window.innerHeight - 56;
    if (window.innerWidth < 403)
        h -= 38;

    app.chart.resize(w, h);
}

d3.select(window).on('resize', windowResize);
windowResize();
        </script>
    </body>
</html>
 
